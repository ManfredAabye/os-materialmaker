name: Build os-materialmaker

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller>=6.0.0 pillow>=10.0.0 requests>=2.31.0 tkinterdnd2 numpy
        
    - name: Get latest version file
      id: get_version
      run: |
        $files = Get-ChildItem -Name "os-materialmaker_*.py" | Sort-Object {
          # Extract version numbers for proper sorting
          if ($_ -match "os-materialmaker_(\d+)\.(\d+)\.(\d+)\.py") {
            [version]"$($matches[1]).$($matches[2]).$($matches[3])"
          } else { [version]"0.0.0" }
        }
        $latest = $files | Select-Object -Last 1
        if (-not $latest) {
          Write-Error "No os-materialmaker_*.py files found!"
          exit 1
        }
        $version = ($latest -replace "os-materialmaker_(.+)\.py", '$1')
        Write-Output "latest_file=$latest" >> $env:GITHUB_OUTPUT
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Latest file: $latest"
        Write-Host "Version: $version"
        
    - name: Syntax check
      run: |
        $file = "${{ steps.get_version.outputs.latest_file }}"
        Write-Host "Checking syntax for file: $file"
        if (-not (Test-Path $file)) {
          Write-Error "File not found: $file"
          exit 1
        }
        python -m py_compile $file
        
    - name: Build with PyInstaller
      run: |
        $iconPath = ""
        if (Test-Path "Resources\PBRlogok.png") { $iconPath = "--icon=Resources\PBRlogok.png" }
        
        pyinstaller --onefile --windowed --name "os-materialmaker-${{ steps.get_version.outputs.version }}-windows" $iconPath --add-data "Resources;Resources" --hidden-import="tkinter" --hidden-import="PIL" --hidden-import="tkinterdnd2" --hidden-import="numpy" ${{ steps.get_version.outputs.latest_file }}
        
    - name: Create portable package
      run: |
        New-Item -ItemType Directory -Path "portable" -Force
        Copy-Item "dist\os-materialmaker-${{ steps.get_version.outputs.version }}-windows.exe" "portable\"
        if (Test-Path "Resources") { Copy-Item "Resources" "portable\" -Recurse }
        if (Test-Path "README.md") { Copy-Item "README.md" "portable\" }
        if (Test-Path "LICENSE") { Copy-Item "LICENSE" "portable\" }
        
        @"
        @echo off
        echo Starting os-materialmaker...
        os-materialmaker-${{ steps.get_version.outputs.version }}-windows.exe
        pause
        "@ | Out-File -FilePath "portable\start.bat" -Encoding ASCII
        
        Compress-Archive -Path "portable\*" -DestinationPath "os-materialmaker-${{ steps.get_version.outputs.version }}-windows-portable.zip"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build-${{ steps.get_version.outputs.version }}
        path: |
          dist/os-materialmaker-${{ steps.get_version.outputs.version }}-windows.exe
          os-materialmaker-${{ steps.get_version.outputs.version }}-windows-portable.zip

  release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: [build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: List downloaded files (debug)
      run: |
        echo "=== Downloaded files ==="
        ls -la
        echo "=== EXE files ==="
        find . -name "*.exe" -type f || echo "No EXE files found"
        echo "=== ZIP files ==="  
        find . -name "*.zip" -type f || echo "No ZIP files found"
        
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          ## OS Material Maker v${{ steps.get_version.outputs.version }}
          
          ### üöÄ Features
          - PBR Material Editor f√ºr Second Life/OpenSim
          - Kategorisierte Parameter mit Emoji-Icons  
          - GLTF Export Funktionalit√§t
          - Auto-Find Algorithmus f√ºr Texturen
          - Vereinfachte 2D-Vorschau
          
          ### üì¶ Downloads
          - **Windows EXE**: `os-materialmaker-${{ steps.get_version.outputs.version }}-windows.exe`
          - **Windows Portable**: `os-materialmaker-${{ steps.get_version.outputs.version }}-windows-portable.zip`
          
          ### üõ†Ô∏è Installation
          1. Download das Windows EXE oder Portable ZIP
          2. F√ºr Portable: Entpacke und f√ºhre `start.bat` aus
          3. F√ºr EXE: Direkt ausf√ºhren
          
          ### üìã Systemanforderungen
          - Windows 10 oder h√∂her
          - Keine Python-Installation erforderlich
          
        files: |
          **/*.exe
          **/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
